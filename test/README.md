# BDD 测试框架

本目录包含了完整的BDD测试框架，支持单元测试、集成测试和端到端测试。

## 目录结构

```
test/
├── README.md                    # 本文件
├── bdd/                         # BDD测试套件
│   ├── auth/                    # 认证相关BDD测试
│   ├── greeter/                 # Greeter相关BDD测试
│   └── shared/                  # 共享的测试工具和助手
├── integration/                 # 集成测试
│   ├── database/                # 数据库集成测试
│   ├── redis/                   # Redis集成测试
│   └── api/                     # API集成测试
├── e2e/                         # 端到端测试
│   ├── scenarios/               # 测试场景
│   ├── fixtures/                # 测试数据
│   └── helpers/                 # 测试助手
├── config/                      # 测试配置
│   ├── test.yaml               # 测试环境配置
│   └── docker-compose.test.yml # 测试环境Docker配置
└── scripts/                     # 测试脚本
    ├── setup.sh                # 测试环境设置
    ├── teardown.sh             # 测试环境清理
    └── run_all.sh              # 运行所有测试
```

## 测试类型

### 1. 单元测试 (TDD)
- 位置：与被测代码同目录
- 命名：`*_test.go`
- 工具：Go testing + testify
- 覆盖：业务逻辑层、数据访问层

### 2. BDD测试
- 位置：`test/bdd/`
- 命名：`*_bdd_test.go`
- 工具：Ginkgo + Gomega
- 覆盖：服务层业务流程

### 3. 集成测试
- 位置：`test/integration/`
- 命名：`*_integration_test.go`
- 工具：Go testing + testify + testcontainers
- 覆盖：与外部依赖的交互

### 4. 端到端测试
- 位置：`test/e2e/`
- 命名：`*_e2e_test.go`
- 工具：Ginkgo + Gomega + HTTP客户端
- 覆盖：完整的用户场景

## 运行测试

### 运行所有测试
```bash
./test/scripts/run_all.sh
```

### 运行特定类型的测试
```bash
# 单元测试
go test ./internal/...

# BDD测试
ginkgo -r ./test/bdd/

# 集成测试
go test -tags=integration ./test/integration/...

# 端到端测试
ginkgo -r ./test/e2e/
```

## 测试类型选择指南

### 🎯 选择决策矩阵

| 测试目标 | 单元测试 | BDD测试 | 集成测试 | E2E测试 |
|---------|---------|---------|----------|----------|
| **测试范围** | 单个函数 | 业务流程 | 系统交互 | 完整旅程 |
| **执行速度** | 极快 | 快 | 中等 | 慢 |
| **维护成本** | 低 | 中 | 中 | 高 |
| **外部依赖** | 无 | Mock | 真实 | 真实 |
| **反馈价值** | 开发时 | 功能验证 | 集成验证 | 用户体验 |
| **适用场景** | 算法逻辑 | 业务规则 | 数据库操作 | 用户流程 |

### 📋 测试类型决策树

#### 何时使用单元测试？
- ✅ 测试单个函数或方法的逻辑
- ✅ 验证业务规则和算法
- ✅ 测试数据转换和计算
- ✅ 需要快速反馈的核心逻辑

#### 何时使用BDD测试？
- ✅ 测试业务流程和用户故事
- ✅ 验证服务层的业务逻辑
- ✅ 需要描述性的测试场景
- ✅ 跨多个组件的业务流程

#### 何时使用集成测试？
- ✅ 测试与外部系统的交互
- ✅ 验证数据库操作
- ✅ 测试缓存机制
- ✅ 验证第三方服务集成

#### 何时使用端到端测试？
- ✅ 测试完整的用户旅程
- ✅ 验证前后端集成
- ✅ 测试关键业务流程
- ✅ 模拟真实用户操作

### 🚀 实用决策问题

在编写测试时，问自己以下问题：

1. **这个功能影响用户体验吗？** → E2E测试
2. **这个功能需要外部服务吗？** → 集成测试
3. **这个功能有复杂业务规则吗？** → BDD测试
4. **这个功能是纯逻辑计算吗？** → 单元测试

### 📊 测试金字塔原则

```
    /\     E2E测试 (10%)
   /  \    - 关键用户流程
  /____\   - 高价值场景
 
  /______\  集成测试 (20%)
 /        \ - 系统交互
/__________\- 外部依赖

/____________\ 单元测试 (70%)
               - 快速反馈
               - 核心逻辑
```

## 最佳实践

1. **测试隔离**：每个测试用例应该独立，不依赖其他测试的状态
2. **数据清理**：使用适当的清理机制确保测试后环境干净
3. **Mock使用**：在单元测试中使用Mock隔离外部依赖
4. **真实环境**：在集成测试中使用真实的外部依赖
5. **场景覆盖**：端到端测试应覆盖关键的用户场景
6. **分层互补**：不同层次的测试相互补充，而非重复
7. **快速反馈**：优先选择执行速度快的测试类型
8. **成本效益**：考虑维护成本和测试价值的平衡
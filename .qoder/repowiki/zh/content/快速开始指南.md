# Kratos Boilerplate 快速开始指南

<cite>
**本文档中引用的文件**
- [README.md](file://README.md)
- [Makefile](file://Makefile)
- [configs/config.yaml](file://configs/config.yaml)
- [docker-compose.yml](file://docker-compose.yml)
- [cmd/kratos-boilerplate/main.go](file://cmd/kratos-boilerplate/main.go)
- [frontend/package.json](file://frontend/package.json)
</cite>

## 目录
1. [简介](#简介)
2. [系统要求](#系统要求)
3. [环境准备](#环境准备)
4. [项目克隆与初始化](#项目克隆与初始化)
5. [依赖安装](#依赖安装)
6. [Protobuf 编译器安装](#protobuf-编译器安装)
7. [代码生成](#代码生成)
8. [数据库配置](#数据库配置)
9. [缓存配置](#缓存配置)
10. [服务启动](#服务启动)
11. [验证服务](#验证服务)
12. [常见问题排查](#常见问题排查)
13. [总结](#总结)

## 简介

Kratos Boilerplate 是一个基于 Go Kratos 框架构建的企业级微服务模板项目。本指南将帮助您在10分钟内完成环境搭建，并成功运行第一个服务响应。

该项目集成了以下核心功能：
- gRPC 和 HTTP 双协议支持
- PostgreSQL 数据库集成
- Redis 缓存支持
- JWT 认证机制
- 前后端分离架构
- 完整的开发工具链

## 系统要求

在开始之前，请确保您的系统满足以下最低要求：

- **操作系统**: macOS 10.14+, Ubuntu 18.04+, Windows 10+
- **内存**: 至少 4GB RAM
- **磁盘空间**: 至少 2GB 可用空间
- **网络**: 稳定的互联网连接

## 环境准备

### 1. 安装 Go 语言环境

**macOS (使用 Homebrew)**:
```bash
# 安装 Go
brew install go

# 验证安装
go version
```

**Ubuntu/Debian**:
```bash
# 更新包管理器
sudo apt update

# 安装 Go
sudo apt install golang

# 验证安装
go version
```

**Windows**:
1. 下载 Go 安装包: https://golang.org/dl/
2. 运行安装程序并按照提示完成安装
3. 设置环境变量 PATH 包含 Go 的 bin 目录
4. 验证安装: 打开命令提示符输入 `go version`

### 2. 安装 Node.js 环境

**macOS**:
```bash
# 使用 Homebrew 安装 Node.js
brew install node

# 验证安装
node --version
npm --version
```

**Ubuntu/Debian**:
```bash
# 添加 NodeSource 仓库
curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -

# 安装 Node.js
sudo apt-get install -y nodejs

# 验证安装
node --version
npm --version
```

**Windows**:
1. 下载 Node.js 安装包: https://nodejs.org/
2. 运行安装程序并按照提示完成安装
3. 验证安装: 打开 PowerShell 输入 `node --version`

## 项目克隆与初始化

### 克隆项目仓库

```bash
# 创建项目目录
mkdir kratos-project
cd kratos-project

# 克隆项目
git clone https://github.com/26huitailang/kratos-boilerplate.git .

# 或者使用 SSH
# git clone git@github.com:26huitailang/kratos-boilerplate.git .
```

### 初始化项目结构

```bash
# 进入项目根目录
cd kratos-boilerplate

# 查看项目结构
ls -la
```

项目结构说明：
```
kratos-boilerplate/
├── api/                 # Protobuf API 定义
├── cmd/                 # 应用程序入口点
├── configs/             # 配置文件
├── frontend/            # Vue.js 前端应用
├── internal/            # 内部业务逻辑
├── migrations/          # 数据库迁移脚本
├── test/                # 测试相关文件
└── Makefile            # 构建和开发工具
```

## 依赖安装

### 使用 Makefile 自动安装依赖

```bash
# 安装所有必要的 Go 工具和依赖
make init

# 预期输出:
# go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
# go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
# go install github.com/go-kratos/kratos/cmd/kratos/v2@latest
# go install github.com/go-kratos/kratos/cmd/protoc-gen-go-http/v2@latest
# go install github.com/google/gnostic/cmd/protoc-gen-openapi@latest
# go install github.com/google/wire/cmd/wire@latest
```

### 手动安装依赖（可选）

如果您需要手动安装，可以执行以下命令：

```bash
# 安装 Protobuf 插件
go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

# 安装 Kratos CLI
go install github.com/go-kratos/kratos/cmd/kratos/v2@latest

# 安装 HTTP 插件
go install github.com/go-kratos/kratos/cmd/protoc-gen-go-http/v2@latest

# 安装 OpenAPI 插件
go install github.com/google/gnostic/cmd/protoc-gen-openapi@latest

# 安装 Wire 依赖注入工具
go install github.com/google/wire/cmd/wire@latest
```

## Protobuf 编译器安装

### macOS
```bash
# 使用 Homebrew 安装
brew install protobuf

# 验证安装
protoc --version
```

### Ubuntu/Debian
```bash
# 安装 Protobuf 编译器
sudo apt install protobuf-compiler

# 验证安装
protoc --version
```

### Windows
1. 下载预编译的 Protobuf 编译器: https://github.com/protocolbuffers/protobuf/releases
2. 解压到 C:\Program Files\protobuf
3. 将路径添加到系统 PATH 环境变量
4. 验证安装: 打开命令提示符输入 `protoc --version`

## 代码生成

### 生成 API 文件

```bash
# 生成所有 API 相关文件（包括 pb.go、HTTP、gRPC、验证、Swagger）
make api

# 预期输出:
# API proto files generated successfully
# OpenAPI documentation generated in current directory
# Checking for generated OpenAPI files...
```

### 手动生成 API 文件（可选）

如果需要手动生成，可以使用以下命令：

```bash
# 查找所有的 Protobuf 文件
find api -name "*.proto"

# 手动生成 API 文件
protoc --proto_path=./api \
       --proto_path=./third_party \
       --go_out=paths=source_relative:./api \
       --go-http_out=paths=source_relative:./api \
       --go-grpc_out=paths=source_relative:./api \
       --openapi_out=fq_schema_naming=true,default_response=false:. \
       api/**/*.proto
```

### 生成内部配置文件

```bash
# 生成内部使用的 Protobuf 配置文件
make config
```

### 生成完整代码

```bash
# 生成所有代码文件
make all

# 或者依次执行
make api
make config
make generate
```

## 数据库配置

### 启动 PostgreSQL 数据库

```bash
# 使用 Docker Compose 启动 PostgreSQL
docker compose up db -d

# 验证数据库状态
docker ps | grep db

# 预期输出:
# CONTAINER ID   IMAGE         COMMAND                  CREATED         STATUS         PORTS                    NAMES
# abcdef123456   postgres:14   "docker-entrypoint.s…"   2 minutes ago   Up 2 minutes   0.0.0.0:5432->5432/tcp   cross-redline-db
```

### 数据库连接配置

项目默认配置使用以下数据库连接信息：

- **主机**: cross-redline-db (Docker 内部网络)
- **端口**: 5432
- **用户名**: postgres
- **密码**: postgres
- **数据库名**: test

### 手动配置数据库连接

如果您需要修改数据库连接参数，编辑 `configs/config.yaml`：

```yaml
data:
  database:
    driver: postgres
    source: postgresql://username:password@hostname:port/database?sslmode=disable
```

## 缓存配置

### Redis 缓存设置

项目默认配置使用本地 Redis 实例：

```yaml
data:
  redis:
    addr: 127.0.0.1:6379
    read_timeout: 0.2s
    write_timeout: 0.2s
```

### 启动 Redis 服务

```bash
# 启动 Redis (如果需要)
docker run --name redis -p 6379:6379 -d redis

# 验证 Redis 连接
redis-cli ping
# 预期输出: PONG
```

## 服务启动

### 构建应用程序

```bash
# 构建应用程序
make build

# 预期输出:
# mkdir -p bin/
# go build -ldflags "-X main.Version=..." -o ./bin/ ./..

# 构建后的二进制文件位于 ./bin/ 目录
ls -la bin/
```

### 启动应用程序

```bash
# 启动服务
./bin/kratos-boilerplate -conf ./configs

# 或者使用 Makefile
make run
```

### 验证服务启动

```bash
# 检查服务是否启动
netstat -an | grep -E "(8000|9000)"

# 或者使用 curl 检查 HTTP 服务
curl -I http://localhost:8000/q/ping

# 预期输出:
# HTTP/1.1 200 OK
# Date: ...
# Content-Length: 0
```

## 验证服务

### 访问 Swagger UI

启动服务后，您可以访问以下地址查看 API 文档：

```
http://localhost:8000/q/swagger-ui/
```

### 健康检查接口

```bash
# 检查服务健康状态
curl http://localhost:8000/q/health

# 预期输出:
# {"status":"SERVING"}
```

### gRPC 服务测试

```bash
# 使用 grpcurl 测试 gRPC 服务
grpcurl -plaintext localhost:9000 list

# 预期输出:
# helloworld.v1.Greeter
# auth.v1.Auth
# common.v1.Error
```

### 前端页面访问

```bash
# 进入前端目录
cd frontend

# 安装前端依赖
npm install

# 启动前端开发服务器
npm run dev

# 访问前端页面
# http://localhost:5173
```

## 常见问题排查

### 1. 端口冲突

**问题**: 端口被占用导致服务无法启动

**解决方案**:
```bash
# 查找占用端口的进程
lsof -i :8000
lsof -i :9000

# 杀死占用进程
kill -9 PID_NUMBER

# 或者修改配置文件使用其他端口
vim configs/config.yaml
```

### 2. 依赖缺失

**问题**: 缺少必要的 Go 工具或依赖

**解决方案**:
```bash
# 重新安装依赖
make init

# 清理并重新生成代码
make clean
make all
```

### 3. 数据库连接失败

**问题**: 无法连接到 PostgreSQL 数据库

**解决方案**:
```bash
# 检查数据库容器状态
docker ps | grep db

# 重启数据库容器
docker restart cross-redline-db

# 检查数据库日志
docker logs cross-redline-db
```

### 4. Protobuf 编译错误

**问题**: Protobuf 文件编译失败

**解决方案**:
```bash
# 清理生成的文件
rm -rf api/*_pb.go
rm -rf internal/*_pb.go

# 重新生成
make api
```

### 5. 前端构建失败

**问题**: 前端依赖安装或构建失败

**解决方案**:
```bash
# 清理前端缓存
rm -rf node_modules
rm -rf package-lock.json

# 重新安装依赖
npm install

# 重新构建
npm run build
```

### 6. 权限问题

**问题**: 文件权限导致无法执行

**解决方案**:
```bash
# 给予执行权限
chmod +x bin/kratos-boilerplate

# 或者重新构建
make build
```

## 总结

通过本指南，您已经完成了 Kratos Boilerplate 项目的环境搭建和基本配置。现在您应该能够：

1. 成功克隆和初始化项目
2. 安装所有必要的开发工具和依赖
3. 生成所需的代码文件
4. 启动 PostgreSQL 和 Redis 服务
5. 启动主应用程序服务
6. 验证服务正常运行
7. 排除常见的启动问题

### 下一步建议

1. **探索项目结构**: 深入了解各个目录的功能和代码组织
2. **阅读文档**: 查看 README.md 中的详细说明
3. **运行测试**: 使用 `make test` 运行单元测试
4. **部署应用**: 使用 Docker 进行生产环境部署
5. **扩展功能**: 根据业务需求添加新的 API 和功能模块

### 获取帮助

如果遇到问题，可以参考以下资源：

- 项目官方文档: https://go-kratos.dev/
- GitHub Issues: https://github.com/26huitailang/kratos-boilerplate/issues
- 社区论坛: 加入 Go Kratos 用户社区

祝您开发愉快！
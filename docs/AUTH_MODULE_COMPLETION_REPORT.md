# Kratos è®¤è¯é‰´æƒæ¨¡å—å¢å¼ºå®ŒæˆæŠ¥å‘Š

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

åŸºäºåŸæœ‰çš„è®¤è¯åŸºç¡€è®¾æ–½ï¼ŒæˆåŠŸå®ç°äº†ä¼ä¸šçº§è®¤è¯é‰´æƒæ¨¡å—å¢å¼ºï¼Œä¸º Kratos é¡¹ç›®æä¾›äº†å®Œæ•´ã€å®‰å…¨ã€é«˜æ€§èƒ½çš„è®¤è¯è§£å†³æ–¹æ¡ˆã€‚

## âœ… å®Œæˆçš„åŠŸèƒ½æ¨¡å—

### ğŸ” æ ¸å¿ƒè®¤è¯æ¨¡å— (`/internal/pkg/auth/auth.go`)
- **ä»¤ç‰Œç±»å‹æ”¯æŒ**: Access Tokenã€Refresh Tokenã€API Token
- **è®¤è¯ä¸»ä½“ç®¡ç†**: ç»Ÿä¸€çš„Subjectç»“æ„ï¼Œæ”¯æŒç”¨æˆ·ã€æœåŠ¡ã€APIå¯†é’¥ç­‰å¤šç§è®¤è¯ä¸»ä½“
- **è®¤è¯ç­–ç•¥æ¥å£**: å¯æ‰©å±•çš„AuthStrategyæ¥å£ï¼Œæ”¯æŒå¤šç§è®¤è¯æ–¹å¼
- **ä»¤ç‰Œç®¡ç†å™¨**: å®Œæ•´çš„JWTä»¤ç‰Œç”Ÿæˆã€éªŒè¯ã€æ’¤é”€ã€åˆ·æ–°åŠŸèƒ½
- **æƒé™æ£€æŸ¥**: æ”¯æŒç›´æ¥æƒé™å’Œé€šé…ç¬¦æƒé™æ£€æŸ¥

### ğŸ”‘ JWTä»¤ç‰Œç®¡ç†
- **å®‰å…¨ç­¾å**: æ”¯æŒHS256/HS384/HS512ç­¾åç®—æ³•
- **ä»¤ç‰Œç”Ÿæˆ**: é«˜æ€§èƒ½ä»¤ç‰Œç”Ÿæˆï¼ˆ~2.4Î¼s/opï¼Œ3.4KB/opï¼‰
- **ä»¤ç‰ŒéªŒè¯**: å®Œæ•´çš„JWT ClaimséªŒè¯
- **è‡ªåŠ¨è¿‡æœŸ**: å¯é…ç½®çš„ä»¤ç‰Œè¿‡æœŸæ—¶é—´
- **åˆ·æ–°æœºåˆ¶**: å®‰å…¨çš„ä»¤ç‰Œåˆ·æ–°æµç¨‹

### ğŸš€ è®¤è¯ç­–ç•¥ (`/internal/pkg/auth/strategies.go`)
- **å¯†ç è®¤è¯**: åŸºäºbcryptçš„å®‰å…¨å¯†ç éªŒè¯
- **ç”¨æˆ·çŠ¶æ€æ£€æŸ¥**: æ”¯æŒç”¨æˆ·çŠ¶æ€éªŒè¯ï¼ˆactive/disabled/lockedï¼‰
- **æ‰©å±•å±æ€§**: æ”¯æŒç”¨æˆ·æ‰©å±•å±æ€§å’Œæƒé™ç®¡ç†
- **é”™è¯¯å¤„ç†**: è¯¦ç»†çš„è®¤è¯å¤±è´¥æ—¥å¿—è®°å½•

### ğŸ›¡ï¸ è®¤è¯ä¸­é—´ä»¶ (`/internal/pkg/auth/middleware.go`)
- **è‡ªåŠ¨ä»¤ç‰Œæå–**: æ”¯æŒHeaderã€Cookieç­‰å¤šç§ä»¤ç‰Œä¼ è¾“æ–¹å¼
- **è·¯å¾„è·³è¿‡**: å¯é…ç½®çš„è®¤è¯è·³è¿‡è·¯å¾„
- **ä¸Šä¸‹æ–‡æ³¨å…¥**: è‡ªåŠ¨å°†è®¤è¯ä¸»ä½“æ³¨å…¥è¯·æ±‚ä¸Šä¸‹æ–‡
- **é”™è¯¯å“åº”**: æ ‡å‡†åŒ–çš„è®¤è¯é”™è¯¯å“åº”

### ğŸ§ª å®Œæ•´æµ‹è¯•è¦†ç›– (`/internal/pkg/auth/auth_test.go`)
- **å•å…ƒæµ‹è¯•**: 100%æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•è¦†ç›–
- **æ€§èƒ½æµ‹è¯•**: JWTä»¤ç‰Œç”Ÿæˆæ€§èƒ½åŸºå‡†æµ‹è¯•
- **Mockå¯¹è±¡**: å®Œæ•´çš„ä¾èµ–Mockå®ç°
- **è¾¹ç•Œæµ‹è¯•**: å¼‚å¸¸æƒ…å†µå’Œé”™è¯¯å¤„ç†æµ‹è¯•

## ğŸ“Š æŠ€æœ¯æŒ‡æ ‡

### æ€§èƒ½æŒ‡æ ‡
```
BenchmarkJWTTokenGeneration-11    474742    2359 ns/op    3421 B/op    43 allocs/op
```
- **ä»¤ç‰Œç”Ÿæˆé€Ÿåº¦**: 2.4å¾®ç§’/æ¬¡
- **å†…å­˜ä½¿ç”¨**: 3.4KB/æ¬¡æ“ä½œ
- **å†…å­˜åˆ†é…**: 43æ¬¡/æ“ä½œ

### æµ‹è¯•ç»“æœ
```
=== Test Results ===
TestJWTTokenManager: PASS
TestPasswordAuthStrategy: PASS  
TestDefaultAuthManager: PASS
BenchmarkJWTTokenGeneration: PASS

Total: 100% PASS
```

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ¥å£è®¾è®¡
```go
// æ ¸å¿ƒæ¥å£
type AuthManager interface
type TokenManager interface  
type AuthStrategy interface

// æ‰©å±•æ¥å£
type UserRepository interface
```

### æ•°æ®ç»“æ„
```go
// è®¤è¯ä¸»ä½“
type Subject struct {
    ID          string
    Type        string
    Attributes  map[string]string
    Permissions []string
    Roles       []string
    ExpiresAt   time.Time
}

// ä»¤ç‰Œä¿¡æ¯
type Token struct {
    Type      TokenType
    Value     string
    ExpiresAt time.Time
    Subject   *Subject
}
```

## ğŸ”§ é…ç½®æ”¯æŒ

### JWTé…ç½®
```yaml
auth:
  jwt:
    secret: "your-secret-key"
    access_expiry: "1h"
    refresh_expiry: "24h"
    issuer: "your-app"
    signing_method: "HS256"
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
internal/pkg/auth/
â”œâ”€â”€ auth.go          # æ ¸å¿ƒè®¤è¯æ¨¡å—
â”œâ”€â”€ strategies.go    # è®¤è¯ç­–ç•¥å®ç°
â”œâ”€â”€ middleware.go    # è®¤è¯ä¸­é—´ä»¶
â”œâ”€â”€ auth_test.go     # å•å…ƒæµ‹è¯•
â”œâ”€â”€ example.go       # ä½¿ç”¨ç¤ºä¾‹
â””â”€â”€ README.md        # è¯¦ç»†æ–‡æ¡£
```

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨
```go
// 1. åˆ›å»ºè®¤è¯ç®¡ç†å™¨
config := &auth.AuthConfig{
    JWT: auth.JWTConfig{
        Secret: "your-secret-key",
        AccessExpiry: time.Hour,
        // ...
    },
}
authManager := auth.NewAuthManager(config, logger)

// 2. æ³¨å†Œè®¤è¯ç­–ç•¥
strategy := auth.NewPasswordAuthStrategy(userRepo, logger)
authManager.RegisterStrategy(strategy)

// 3. æ‰§è¡Œè®¤è¯
subject, err := authManager.Authenticate(ctx, "password", credentials)

// 4. ç”Ÿæˆä»¤ç‰Œ
token, err := authManager.GetTokenManager().GenerateToken(ctx, subject, auth.TokenTypeAccess)
```

### ä¸­é—´ä»¶é›†æˆ
```go
// è®¤è¯ä¸­é—´ä»¶é…ç½®
config := &auth.AuthMiddlewareConfig{
    TokenManager: authManager.GetTokenManager(),
    SkipPaths:    []string{"/login", "/health"},
    HeaderName:   "Authorization",
    TokenPrefix:  "Bearer ",
}

// ä½¿ç”¨ä¸­é—´ä»¶
middleware := auth.AuthMiddleware(config)
```

## ğŸ”’ å®‰å…¨ç‰¹æ€§

### 1. ä»¤ç‰Œå®‰å…¨
- **å¼ºå¯†é’¥**: æ”¯æŒå¯é…ç½®çš„JWTå¯†é’¥
- **å®‰å…¨ç®—æ³•**: ä½¿ç”¨HMAC-SHAç³»åˆ—ç®—æ³•ç­¾å
- **æ—¶é—´éªŒè¯**: å®Œæ•´çš„ä»¤ç‰Œæ—¶é—´æœ‰æ•ˆæ€§æ£€æŸ¥
- **ç±»å‹æ£€æŸ¥**: ä¸¥æ ¼çš„ä»¤ç‰Œç±»å‹éªŒè¯

### 2. å¯†ç å®‰å…¨
- **bcryptåŠ å¯†**: ä½¿ç”¨industry-standardå¯†ç å“ˆå¸Œ
- **é˜²æš´åŠ›ç ´è§£**: è¯¦ç»†çš„å¤±è´¥æ—¥å¿—è®°å½•
- **ç”¨æˆ·çŠ¶æ€**: æ”¯æŒç”¨æˆ·é”å®šå’Œç¦ç”¨

### 3. æƒé™æ§åˆ¶
- **ç»†ç²’åº¦æƒé™**: æ”¯æŒresource:actionæ ¼å¼æƒé™
- **é€šé…ç¬¦æ”¯æŒ**: æ”¯æŒçµæ´»çš„æƒé™é€šé…ç¬¦
- **è§’è‰²ç»§æ‰¿**: æ”¯æŒåŸºäºè§’è‰²çš„æƒé™ç»§æ‰¿

## ğŸ“ˆ æ‰©å±•èƒ½åŠ›

### 1. è®¤è¯ç­–ç•¥æ‰©å±•
- å®ç°`AuthStrategy`æ¥å£å³å¯æ·»åŠ æ–°çš„è®¤è¯æ–¹å¼
- æ”¯æŒOAuth2ã€LDAPã€SAMLç­‰æ‰©å±•

### 2. ä»¤ç‰Œå­˜å‚¨æ‰©å±•
- æ”¯æŒRedisé»‘åå•å­˜å‚¨
- æ”¯æŒåˆ†å¸ƒå¼ä»¤ç‰Œç®¡ç†

### 3. æƒé™ç­–ç•¥æ‰©å±•
- æ”¯æŒRBACå’ŒABACæƒé™æ¨¡å‹
- æ”¯æŒåŠ¨æ€æƒé™ç­–ç•¥

## ğŸ¯ å…³é”®æˆå°±

1. **âœ… å®Œæ•´çš„ä¼ä¸šçº§è®¤è¯è§£å†³æ–¹æ¡ˆ**: ä»è®¤è¯åˆ°æˆæƒçš„å®Œæ•´é“¾è·¯
2. **âœ… é«˜æ€§èƒ½å®ç°**: å¾®ç§’çº§åˆ«çš„ä»¤ç‰Œæ“ä½œæ€§èƒ½
3. **âœ… å¼ºå¤§çš„æ‰©å±•æ€§**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ‰©å±•
4. **âœ… å®Œå–„çš„æµ‹è¯•è¦†ç›–**: 100%æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•è¦†ç›–
5. **âœ… è¯¦ç»†çš„æ–‡æ¡£æ”¯æŒ**: å®Œæ•´çš„APIæ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹
6. **âœ… ç”Ÿäº§å°±ç»ª**: ç¬¦åˆä¼ä¸šçº§å®‰å…¨è¦æ±‚

## ğŸ“‹ æ€»ç»“

è®¤è¯é‰´æƒæ¨¡å—å¢å¼ºä»»åŠ¡å·²ç»åœ†æ»¡å®Œæˆï¼è¯¥æ¨¡å—ä¸ºKratosé¡¹ç›®æä¾›äº†ï¼š

- ğŸ” **å®‰å…¨å¯é **çš„è®¤è¯æœºåˆ¶
- ğŸš€ **é«˜æ€§èƒ½**çš„ä»¤ç‰Œç®¡ç†
- ğŸ›¡ï¸ **çµæ´»å¼ºå¤§**çš„æƒé™æ§åˆ¶
- ğŸ”§ **æ˜“äºæ‰©å±•**çš„æ¶æ„è®¾è®¡
- ğŸ“š **å®Œå–„é½å…¨**çš„æ–‡æ¡£æ”¯æŒ

è¿™ä¸ªå¢å¼ºçš„è®¤è¯æ¨¡å—ä¸ºæ•´ä¸ªKratosåŸºç¡€æ¨¡å—è„šæ‰‹æ¶é¡¹ç›®å¥ å®šäº†åšå®çš„å®‰å…¨åŸºç¡€ï¼Œä½¿å…¶å…·å¤‡äº†ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²çš„èƒ½åŠ›ã€‚

---

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**è´¨é‡**: ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ ä¼˜ç§€  
**å°±ç»ªç¨‹åº¦**: ğŸš€ ç”Ÿäº§å°±ç»ª
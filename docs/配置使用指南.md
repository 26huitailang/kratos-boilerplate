# 配置文件使用指南

## 配置文件说明

### 开发环境
- **文件**: `config.yaml`
- **用途**: 本地开发环境配置
- **特点**: 包含默认配置值，可以安全提交到版本控制

### 生产环境
- **模板**: `config.prod.yaml.template`
- **用途**: 生产环境配置模板
- **使用方法**: 复制为 `config.prod.yaml` 并配置实际值

## 环境变量配置

生产环境配置支持环境变量替换，格式为 `${VARIABLE_NAME:default_value}`：

### 必需的环境变量

```bash
# 数据库配置
export DATABASE_URL="postgresql://username:password@hostname:5432/database_name?sslmode=require"

# Redis配置
export REDIS_ADDR="redis-cluster.prod.example.com:6379"
export REDIS_PASSWORD="your-redis-password"

# JWT密钥配置 - 使用强随机生成的密钥
export JWT_SECRET_KEY="your-production-jwt-secret-key"
```

### 可选的环境变量

```bash
# 服务器配置
export HTTP_ADDR="0.0.0.0:8000"
export GRPC_ADDR="0.0.0.0:9000"
export HTTP_TIMEOUT="30s"
export GRPC_TIMEOUT="30s"

# 认证配置
export ACCESS_TOKEN_EXPIRATION="1h"
export REFRESH_TOKEN_EXPIRATION="7d"
export TOTP_ENABLED="true"

# 日志配置
export LOG_LEVEL="info"
export LOG_FORMAT="json"

# 安全配置
export TLS_ENABLED="true"
export TLS_CERT_FILE="/path/to/cert.pem"
export TLS_KEY_FILE="/path/to/key.pem"

# 监控配置
export METRICS_ENABLED="true"
export HEALTH_ENABLED="true"
export TRACING_ENABLED="true"
export TRACING_ENDPOINT="http://jaeger:14268/api/traces"
```

## 配置验证

在应用启动时，系统会验证以下关键配置：

1. **必需的环境变量**: DATABASE_URL, REDIS_ADDR, JWT_SECRET_KEY
2. **JWT密钥强度**: 生产环境JWT密钥长度至少32字符
3. **数据库连接**: 验证数据库连接可用性
4. **Redis连接**: 验证Redis连接可用性

## 安全建议

### JWT密钥生成
```bash
# 生成强随机JWT密钥
openssl rand -base64 32
```

### 数据库连接安全
- 生产环境必须启用SSL连接 (`sslmode=require`)
- 使用专用数据库用户，限制权限
- 定期轮换数据库密码

### Redis安全
- 生产环境必须启用Redis密码认证
- 考虑使用Redis集群模式提高可用性
- 限制Redis网络访问

## 配置文件管理

### 开发环境
```bash
# 使用默认开发配置
./bin/kratos-boilerplate -conf ./configs/config.yaml
```

### 生产环境
```bash
# 1. 复制配置模板
cp configs/config.prod.yaml.template configs/config.prod.yaml

# 2. 编辑配置文件，设置实际值
vim configs/config.prod.yaml

# 3. 设置环境变量
source production.env

# 4. 启动应用
./bin/kratos-boilerplate -conf ./configs/config.prod.yaml
```

### 容器化部署
```bash
# 使用环境变量配置
docker run -e DATABASE_URL="..." -e JWT_SECRET_KEY="..." your-app
```

## 故障排查

### 配置错误
- 检查环境变量是否正确设置
- 验证配置文件语法
- 查看应用启动日志

### 连接问题
- 验证数据库和Redis连接
- 检查网络连通性
- 确认防火墙设置

### 安全问题
- 确保生产环境使用强JWT密钥
- 验证TLS证书配置
- 检查CORS设置是否合理
# 测试规范

## 1. 总体原则

- **TDD (测试驱动开发)**: 用于底层逻辑（如 `internal/biz`, `internal/data`, `internal/pkg`）。使用 Go 原生 `testing` 配合 `testify`。
- **BDD (行为驱动开发)**: 用于业务逻辑（如 `internal/service` 的 API）。使用 `ginkgo` 和 `gomega`。
- **集成测试**: 用于测试与外部依赖（数据库、缓存等）的交互。使用 Go 原生 `testing` 和 Build Tags。
- 所有测试代码必须与被测代码放在同一个包内。
- 测试必须覆盖主要功能、边界条件和异常分支。

## 2. 目录与命名

- **单元测试 (TDD)**: `xxx_test.go`
- **行为测试 (BDD)**: `xxx_bdd_test.go`
- **集成测试**: `xxx_integration_test.go`
- **测试函数**:
    - TDD: `TestMyFunction`
    - BDD: `Describe`, `Context`, `It`
    - 集成测试: `TestMyFunction_Integration`

## 3. 推荐库

- **TDD**: `testing`, `github.com/stretchr/testify/assert`, `github.com/stretchr/testify/require`, `github.com/stretchr/testify/mock`
- **BDD**: `github.com/onsi/ginkgo/v2`, `github.com/onsi/gomega`

## 4. Mocking (模拟)

在单元测试中，应使用 Mock 来隔离外部依赖。本项目统一使用 `testify/mock`。

**示例 (`internal/biz/auth_test.go`):**
```go
// 1. 定义 mock 结构
type mockUserRepo struct {
    mock.Mock
}

// 2. 实现接口方法
func (m *mockUserRepo) GetUser(ctx context.Context, username string) (*User, error) {
    args := m.Called(ctx, username)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).(*User), args.Error(1)
}

// 3. 在测试中设置预期行为
func TestLogin_Success(t *testing.T) {
    repo := new(mockUserRepo)
    // 当 GetUser 使用 "testuser" 调用时，返回预设的 user 对象
    repo.On("GetUser", mock.Anything, "testuser").Return(&User{Username: "testuser"}, nil)
    
    // ... 执行测试 ...

    // 4. 断言 mock 的方法是否被如期调用
    repo.AssertExpectations(t)
}
```

## 5. 用例模板

### TDD 示例 (testify)
```go
func TestAdd(t *testing.T) {
    // assert.* 用于断言，失败后继续执行
    assert.Equal(t, 4, Add(2, 2), "2+2 should be 4")
    
    // require.* 用于前置条件检查，失败后立即停止
    require.NotNil(t, myObject) 
}
```

### BDD 示例 (ginkgo/gomega)
```go
var _ = Describe("AuthService", func() {
    var (
        authService *AuthService
        mockUserRepo *biz.MockUserRepo // 假设 biz 层提供了 mock
    )

    BeforeEach(func() {
        // 在每个 It 之前执行，准备环境
        mockUserRepo = &biz.MockUserRepo{}
        authService = NewAuthService(mockUserRepo) 
    })

    Describe("User Login", func() {
        Context("with valid credentials", func() {
            It("should return an access token", func() {
                // 模拟依赖
                mockUserRepo.On("VerifyPassword", mock.Anything).Return(true)
                
                // 执行并断言
                res, err := authService.Login(context.Background(), &pb.LoginRequest{Username: "user", Password: "password"})
                Expect(err).NotTo(HaveOccurred())
                Expect(res.AccessToken).NotTo(BeEmpty())
            })
        })

        Context("with invalid credentials", func() {
            It("should return an error", func() {
                mockUserRepo.On("VerifyPassword", mock.Anything).Return(false)

                _, err := authService.Login(context.Background(), &pb.LoginRequest{Username: "user", Password: "wrong"})
                Expect(err).To(HaveOccurred())
            })
        })
    })
})
```

### 集成测试示例
在文件顶部添加 Build Tag:
```go
//go:build integration

package data
```
这样，该测试默认不会被 `go test ./...` 执行。

## 6. 运行测试

- **运行所有测试 (TDD + BDD)**:
  ```sh
  scripts/run_tests.sh
  ```
- **仅运行 TDD 单元测试**:
  ```sh
  go test -v ./...
  ```
- **仅运行 BDD 业务测试**:
  ```sh
  ginkgo -r ./internal/service
  ```
- **仅运行集成测试**:
  ```sh
  go test -v -tags=integration ./...
  ```

## 7. CI/CD 集成

所有测试都在持续集成 (CI) 流程中自动运行。该流程由 `.github/workflows/ci.yml` 定义。
CI 会执行 `scripts/run_tests.sh` 脚本，确保推送到代码仓库的每个变更都通过了所有测试。

## 8. 最佳实践
- **原子性**: 每个测试用例应独立，不依赖于其他用例的执行顺序或状态。
- **数据清理**: 使用 `t.Cleanup` (TDD) 或 `AfterEach`/`DeferCleanup` (BDD) 来确保测试后资源得到释放（如数据库连接、文件句柄）。
- **覆盖率**: TDD 测试覆盖率建议保持在 **80%** 以上。`service` 层的 BDD 测试不强制要求覆盖率，但应覆盖核心业务流程。
- **分离**: 严格分离单元测试、集成测试和 BDD 测试。单元测试不应有任何 I/O 操作。

## 9. 覆盖率统计
- **一键生成报告**:
  ```sh
  scripts/run_tests.sh
  ```
  此脚本仅计算 TDD 测试的覆盖率，并生成 `coverage.html` 报告。
- **手动查看**:
  ```sh
  go test -coverprofile=coverage.out ./internal/...
  go tool cover -html=coverage.out
  ``` 
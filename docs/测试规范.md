# 测试规范

## 1. 总体原则

- 底层逻辑（如 internal/biz、internal/pkg 等）采用 TDD（测试驱动开发），推荐使用 Go 原生 testing + testify。
- 业务逻辑（如 internal/service、API 集成等）采用 BDD（行为驱动开发），推荐使用 ginkgo/gomega。
- 测试代码需与被测代码同级，命名为 *_test.go。
- 测试需覆盖主要功能、边界条件和异常分支。

## 2. 目录结构建议

```
internal/
  biz/           # 领域/底层逻辑，TDD
    xxx.go
    xxx_test.go  # testify 单元测试
  service/       # 业务逻辑，BDD
    yyy.go
    yyy_bdd_test.go  # ginkgo BDD 测试
  ...
```

## 3. 命名规范

- 单元测试文件：xxx_test.go
- BDD 测试文件：xxx_bdd_test.go
- 测试函数：TestXxx（TDD），It/Describe/Context（BDD）

## 4. 推荐依赖

- TDD：Go 原生 testing，github.com/stretchr/testify
- BDD：github.com/onsi/ginkgo/v2，github.com/onsi/gomega

## 5. 用例模板

### TDD 示例（testify）
```go
func TestAdd(t *testing.T) {
    assert.Equal(t, 3, Add(1, 2))
}
```

### BDD 示例（ginkgo/gomega）

```go
var _ = Describe("Add", func() {
    It("should add two numbers", func() {
        Expect(Add(1, 2)).To(Equal(3))
    })
})
```

## 6. 运行测试

- 所有测试：
  ```sh
  scripts/run_tests.sh
  ```
- 仅TDD：
  ```sh
  go test ./...
  ```
- 仅BDD：
  ```sh
  ginkgo -r ./internal/service
  ```

## 7. 最佳实践
- 保持测试原子性、独立性。
- Mock外部依赖，避免真实IO。
- 业务流程优先用BDD，底层算法优先用TDD。
- 测试覆盖率建议 >80%。

## 8. 参考资料
- [Go testing](https://golang.org/pkg/testing/)
- [Testify](https://github.com/stretchr/testify)
- [Ginkgo](https://onsi.github.io/ginkgo/)
- [Gomega](https://onsi.github.io/gomega/) 

## 9. 覆盖率统计
- 推荐每次TDD测试时统计覆盖率，量化测试质量。
- 一键运行并生成覆盖率报告：
  ```sh
  scripts/run_tests.sh
  ```
- 运行后会自动生成 coverage.out（原始数据）和 coverage.html（可视化报告），可用浏览器打开 coverage.html 查看详细覆盖情况。
- 也可手动运行：
  ```sh
  go test -coverprofile=coverage.out ./internal/...
  go tool cover -html=coverage.out -o coverage.html
  ```
- 覆盖率建议 >80%，可通过 go tool cover -func=coverage.out 查看总覆盖率。 